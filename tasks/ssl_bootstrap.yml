---
- name: Try to connect agent to server
  ansible.builtin.script:
    cmd: puppet_bootstrap_try.sh
    creates: "{{ puppet_try_file }}"
  register: puppet_bootstrap_try
  delay: 6
  retries: 10
  until: puppet_bootstrap_try is not failed
  when: inventory_hostname == "agent-ubuntu"

- name: Sign agent cert request
  ansible.builtin.command:
    cmd: "{{ puppet_server_bin }} ca sign --certname {{ puppet_agent_hostname }}."
    creates: "{{ puppet_server_config_dir }}/ca/signed/{{ puppet_agent_hostname }}..pem"
  when: inventory_hostname == "server"

- name: Connect agent to server
  ansible.builtin.command:
    cmd: "{{ puppet_agent_bin }} ssl bootstrap"
  register: puppet_bootstrap_cmd
  changed_when: puppet_bootstrap_cmd.rc != 0
  when: inventory_hostname == "agent-ubuntu"
